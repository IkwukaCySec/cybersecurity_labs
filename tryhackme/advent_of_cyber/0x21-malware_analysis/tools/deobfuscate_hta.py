#!/usr/bin/env python3
# Malhare HTA Deobfuscator v2.0
# Handles eval(String.fromCharCode()) and basic concatenation

import re
import sys

def decode_fromcharcode(match):
    codes = [int(x.strip()) for x in match.group(1).split(',') if x.strip()]
    return '"' + ''.join(chr(c) for c in codes if 32 <= c <= 126) + '"'

def deobfuscate(content):
    # Decode String.fromCharCode patterns
    pattern = r'String\.fromCharCode\(([^)]+)\)'
    content = re.sub(pattern, decode_fromcharcode, content)
    
    # Replace eval("decoded") with decoded
    content = re.sub(r'eval\("([^"]+)"\)', r'\1', content)
    
    return content

if __name__ == "__main__":
    if len(sys.argv) != 2:
        print("Usage: python deobfuscate_hta.py <hta_file>")
        sys.exit(1)
    
    with open(sys.argv[1], 'r', encoding='utf-16le', errors='ignore') as f:
        content = f.read()
    
    cleaned = deobfuscate(content)
    
    output = "deobfuscated.js"
    with open(output, 'w', encoding='utf-8') as f:
        f.write(cleaned)
    
    print(f"[+] Deobfuscated JavaScript saved to {output}")
    print("[i] Review for remaining obfuscation layers")
