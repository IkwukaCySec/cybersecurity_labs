input {
  beats {
    port => 5044
  }
}

filter {
  # Only process auth logs
  if [fileset][name] == "auth" or "auth.log" in [log][file][path] {

    # Standard grok for sshd auth lines
    grok {
      match => {
        "message" => "%{SYSLOGTIMESTAMP:syslog_timestamp} %{SYSLOGHOST:syslog_hostname} sshd\\[%{NUMBER:pid}\\]: %{GREEDYDATA:auth_message}"
      }
      tag_on_failure => ["_grokparsefailure_auth"]
    }

    # Tag brute-force indicators
    if [auth_message] =~ "(?i)(Failed password|invalid user|authentication failure)" {
      mutate {
        add_tag => ["brute_force_attempt", "ssh_failed_login"]
        add_field => { "brute_force_category" => "failed_attempt" }
      }
    }

    if [auth_message] =~ "Accepted password" {
      mutate {
        add_tag => ["ssh_success_login"]
        add_field => { "brute_force_category" => "success" }
      }
    }

    # Optional: extract IP and username if present
    grok {
      match => { "auth_message" => "for (invalid user )?%{DATA:ssh_user} from %{IP:ssh_source_ip}" }
      tag_on_failure => ["_grokparsefailure_user_ip"]
    }

    # Convert timestamp to @timestamp
    date {
      match => [ "syslog_timestamp", "MMM  d HH:mm:ss", "MMM dd HH:mm:ss" ]
      target => "@timestamp"
    }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "ssh-logs-%{+YYYY.MM.dd}"
  }
}
